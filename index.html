<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Calorie & Macro Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="card">
    <h1>Calorie & Macro Planner</h1>
    <p class="subtitle">Estimate daily calories and macros based on your stats and goal.</p>

    <form id="planner-form">
      <div class="field">
        <label>Sex</label>
        <div class="radio-group">
          <label><input type="radio" name="sex" value="male" checked> Male</label>
          <label><input type="radio" name="sex" value="female"> Female</label>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="age">Age (years)</label>
          <input id="age" type="number" min="14" max="100" value="20" required>
        </div>
        <div class="field">
          <div class="height-header">
            <label for="height" id="height-label">Height (cm)</label>
            <select id="height-unit" class="unit-select">
              <option value="cm" selected>cm</option>
              <option value="in">in</option>
            </select>
          </div>
          <input id="height" type="number" min="130" max="230" value="173" required>
        </div>
        <div class="field">
          <div class="weight-header">
            <label for="weight" id="weight-label">Weight (kg)</label>
            <select id="weight-unit" class="unit-select">
              <option value="kg" selected>kg</option>
              <option value="lb">lb</option>
            </select>
          </div>
          <input id="weight" type="number" min="35" max="300" value="72" required>
        </div>
      </div>

      <div class="field">
        <label for="activity">Activity level</label>
        <select id="activity">
          <option value="sedentary">Sedentary (little/no exercise)</option>
          <option value="light">Light (1–3 days/wk)</option>
          <option value="moderate" selected>Moderate (3–5 days/wk)</option>
          <option value="very">Very active (6–7 days/wk)</option>
          <option value="extra">Extra active (physical job + training)</option>
        </select>
      </div>

      <div class="row">
        <div class="field">
          <label for="goal">Goal</label>
          <select id="goal">
            <option value="cut">Cut (lose fat)</option>
            <option value="maintain" selected>Maintain</option>
            <option value="bulk">Bulk (gain muscle)</option>
          </select>
        </div>
        <div class="field">
          <label for="pace">Pace</label>
          <select id="pace">
            <option value="slow">Slow</option>
            <option value="normal" selected>Normal</option>
            <option value="aggressive">Aggressive</option>
          </select>
        </div>
      </div>

      <button type="submit" id="submit-btn">Calculate</button>
      <div id="error" class="error hidden"></div>
    </form>

    <div id="results" class="results hidden">
      <h2>Results</h2>
      <div class="grid">
        <div>
          <div class="label-sm">BMR</div>
          <div class="value" id="res-bmr"></div>
        </div>
        <div>
          <div class="label-sm">TDEE</div>
          <div class="value" id="res-tdee"></div>
        </div>
        <div>
          <div class="label-sm">Target calories</div>
          <div class="value" id="res-calories"></div>
        </div>
        <div>
          <div class="label-sm">Weekly change</div>
          <div class="value" id="res-weekly"></div>
        </div>
      </div>

      <h2 class="margin-top">Daily macros</h2>
      <div class="grid">
        <div>
          <div class="label-sm">Protein</div>
          <div class="value" id="res-protein"></div>
        </div>
        <div>
          <div class="label-sm">Fat</div>
          <div class="value" id="res-fat"></div>
        </div>
        <div>
          <div class="label-sm">Carbs</div>
          <div class="value" id="res-carbs"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('planner-form');
    const btn = document.getElementById('submit-btn');
    const errorBox = document.getElementById('error');
    const resultsBox = document.getElementById('results');
    const weightInput = document.getElementById('weight');
    const weightLabel = document.getElementById('weight-label');
    const weightUnitSelect = document.getElementById('weight-unit');
    let currentUnit = 'kg';

    const heightInput = document.getElementById('height');
    const heightLabel = document.getElementById('height-label');
    const heightUnitSelect = document.getElementById('height-unit');
    let currentHeightUnit = 'cm';

    const API_URL = 'http://localhost:8080/plan';

    // Weight unit dropdown functionality
    weightUnitSelect.addEventListener('change', () => {
      const newUnit = weightUnitSelect.value;
      if (newUnit === currentUnit) return;

      const currentValue = parseFloat(weightInput.value);
      if (isNaN(currentValue)) {
        currentUnit = newUnit;
        updateUnitDisplay();
        return;
      }

      // Convert value
      let newValue;
      if (currentUnit === 'kg' && newUnit === 'lb') {
        newValue = currentValue * 2.20462; // kg to lb
        weightInput.min = '77';
        weightInput.max = '661';
      } else {
        newValue = currentValue / 2.20462; // lb to kg
        weightInput.min = '35';
        weightInput.max = '300';
      }

      weightInput.value = Math.round(newValue * 10) / 10;
      currentUnit = newUnit;
      updateUnitDisplay();
    });

    function updateUnitDisplay() {
      weightLabel.textContent = `Weight (${currentUnit})`;
    }

    // Height unit dropdown functionality
    heightUnitSelect.addEventListener('change', () => {
      const newUnit = heightUnitSelect.value;
      if (newUnit === currentHeightUnit) return;

      const currentValue = parseFloat(heightInput.value);
      if (isNaN(currentValue)) {
        currentHeightUnit = newUnit;
        updateHeightUnitDisplay();
        return;
      }

      // Convert value
      let newValue;
      if (currentHeightUnit === 'cm' && newUnit === 'in') {
        newValue = currentValue / 2.54; // cm to inches
        heightInput.min = '51';
        heightInput.max = '91';
      } else {
        newValue = currentValue * 2.54; // inches to cm
        heightInput.min = '130';
        heightInput.max = '230';
      }

      heightInput.value = Math.round(newValue * 10) / 10;
      currentHeightUnit = newUnit;
      updateHeightUnitDisplay();
    });

    function updateHeightUnitDisplay() {
      heightLabel.textContent = `Height (${currentHeightUnit})`;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorBox.classList.add('hidden');
      resultsBox.classList.add('hidden');

      const sex = form.sex.value;
      const age = Number(document.getElementById('age').value);
      let height_cm = Number(document.getElementById('height').value);
      let weight_kg = Number(document.getElementById('weight').value);
      const activity = document.getElementById('activity').value;
      const goal = document.getElementById('goal').value;
      const pace = document.getElementById('pace').value;

      // Convert to cm if currently in inches
      if (currentHeightUnit === 'in') {
        height_cm = height_cm * 2.54;
      }

      // Convert to kg if currently in pounds
      if (currentUnit === 'lb') {
        weight_kg = weight_kg / 2.20462;
      }

      if (!age || !height_cm || !weight_kg) {
        errorBox.textContent = 'Please fill in all numeric fields.';
        errorBox.classList.remove('hidden');
        return;
      }

      const payload = {
        sex,
        age,
        height_cm,
        weight_kg,
        activity,
        goal,
        pace
      };

      btn.disabled = true;
      btn.textContent = 'Calculating...';

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(errData.error || 'Server error');
        }

        const data = await res.json();

        document.getElementById('res-bmr').textContent =
          `${data.bmr.toFixed(1)} kcal`;
        document.getElementById('res-tdee').textContent =
          `${data.tdee.toFixed(1)} kcal`;
        document.getElementById('res-calories').textContent =
          `${data.targetCalories.toFixed(1)} kcal`;

        document.getElementById('res-weekly').textContent =
          `${data.weeklyChangeKg.toFixed(2)} kg / ` +
          `${data.weeklyChangeLb.toFixed(2)} lb`;

        document.getElementById('res-protein').textContent =
          `${data.macros.protein_g.toFixed(0)} g`;
        document.getElementById('res-fat').textContent =
          `${data.macros.fat_g.toFixed(0)} g`;
        document.getElementById('res-carbs').textContent =
          `${data.macros.carbs_g.toFixed(0)} g`;

        resultsBox.classList.remove('hidden');
      } catch (err) {
        errorBox.textContent = err.message;
        errorBox.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Calculate';
      }
    });
  </script>
</body>
</html>
